"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[5],{3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>m});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var c=a.createContext({}),l=function(e){var t=a.useContext(c),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},u=function(e){var t=l(e.components);return a.createElement(c.Provider,{value:t},e.children)},p="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},h=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,c=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),p=l(n),h=r,m=p["".concat(c,".").concat(h)]||p[h]||d[h]||i;return n?a.createElement(m,o(o({ref:t},u),{},{components:n})):a.createElement(m,o({ref:t},u))}));function m(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,o=new Array(i);o[0]=h;var s={};for(var c in t)hasOwnProperty.call(t,c)&&(s[c]=t[c]);s.originalType=e,s[p]="string"==typeof e?e:r,o[1]=s;for(var l=2;l<i;l++)o[l]=n[l];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}h.displayName="MDXCreateElement"},9607:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>o,default:()=>p,frontMatter:()=>i,metadata:()=>s,toc:()=>l});var a=n(7462),r=(n(7294),n(3905));const i={},o="CQL Primer",s={unversionedId:"business-rules/cql_primer",id:"business-rules/cql_primer",title:"CQL Primer",description:"This document describes how to run business rules written in Clinical Quality Language (CQL) against credentials in order to validate that provided data meets jurisdictional business requirements.",source:"@site/docs/business-rules/cql_primer.md",sourceDirName:"business-rules",slug:"/business-rules/cql_primer",permalink:"/cc-pki/business-rules/cql_primer",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/business-rules/cql_primer.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"CQL Execution",permalink:"/cc-pki/business-rules/execution"},next:{title:"COVID",permalink:"/cc-pki/category/covid"}},c={},l=[{value:"Overview",id:"overview",level:2},{value:"Convert Vaccination Credentials to DDCC resource instance",id:"convert-vaccination-credentials-to-ddcc-resource-instance",level:2},{value:"Running the Matchbox Docker Image",id:"running-the-matchbox-docker-image",level:3},{value:"Loading IGs Into Matchbox",id:"loading-igs-into-matchbox",level:3},{value:"Converting the Vaccination Into DDCC FHIR resource",id:"converting-the-vaccination-into-ddcc-fhir-resource",level:3},{value:"Running CQL Against Converted Vaccination Credentials",id:"running-cql-against-converted-vaccination-credentials",level:2},{value:"Translating CQL to ELM",id:"translating-cql-to-elm",level:3},{value:"Running ELM Against Converted Vaccination Credentials",id:"running-elm-against-converted-vaccination-credentials",level:3}],u={toc:l};function p(e){let{components:t,...n}=e;return(0,r.kt)("wrapper",(0,a.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"cql-primer"},"CQL Primer"),(0,r.kt)("p",null,"This document describes how to run business rules written in ",(0,r.kt)("a",{parentName:"p",href:"https://cql.hl7.org/"},"Clinical Quality Language (CQL)")," against credentials in order to validate that provided data meets jurisdictional business requirements."),(0,r.kt)("h2",{id:"overview"},"Overview"),(0,r.kt)("p",null,"The following high level steps, described in detail below, can be used to run CQL business rules against a vaccination record:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Start with a vaccination credential in a supported format and a set of business rules written in CQL"),(0,r.kt)("li",{parentName:"ul"},"Set up the ",(0,r.kt)("a",{parentName:"li",href:"https://github.com/ahdis/matchbox"},"Matchbox")," FHIR Server for transforming credentials"),(0,r.kt)("li",{parentName:"ul"},"Identify the correct StructureMap for converting the vaccination credential into the DDCC CoreDataSet logical model"),(0,r.kt)("li",{parentName:"ul"},"Use Matchbox to transform the credential to a DDCC CoreDataSet logical model instance and then to the corresponding DDCC resource instance"),(0,r.kt)("li",{parentName:"ul"},"Set up the CQL Translation Service for converting CQL into the Expression Logical Model (ELM) representation"),(0,r.kt)("li",{parentName:"ul"},"Set up a ",(0,r.kt)("a",{parentName:"li",href:"https://nodejs.org/"},"Node.js")," project with appropriate CQL dependencies to provide an execution environment for the ELM representation"),(0,r.kt)("li",{parentName:"ul"},"Run the business rules against the FHIR instance")),(0,r.kt)("h2",{id:"convert-vaccination-credentials-to-ddcc-resource-instance"},"Convert Vaccination Credentials to DDCC resource instance"),(0,r.kt)("p",null,"The process starts with converting the vaccination credential to be evaluated into the DDCC FHIR model. For the examples used in this document we'll start with an example credential payload in the SHC format, which you can download:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"curl https://raw.githubusercontent.com/dvci/ddcc/who-88-structuremap-tests/structuremap-tests/fixtures/shc/example-00-b-jws-payload-expanded.json --output example-00-b-jws-payload-expanded.json\n")),(0,r.kt)("p",null,(0,r.kt)("em",{parentName:"p"},"TODO: Update the location of this example once merged")),(0,r.kt)("p",null,"Credentials can be converted using the appropriate StructureMaps using the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/ahdis/matchbox"},"Matchbox")," FHIR Server."),(0,r.kt)("h3",{id:"running-the-matchbox-docker-image"},"Running the Matchbox Docker Image"),(0,r.kt)("p",null,"The Matchbox server can be run via its docker image.  The following command starts the docker image on a local machine listening on port 8080:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"docker run -d -p 8080:8080 --restart unless-stopped eu.gcr.io/fhir-ch/matchbox:v230\n")),(0,r.kt)("p",null,"Running Matchbox in this fashion uses an in-memory data store rather than a backing database, so will not persist state across different container instantiations."),(0,r.kt)("h3",{id:"loading-igs-into-matchbox"},"Loading IGs Into Matchbox"),(0,r.kt)("p",null,"Matchbox needs the appropriate IGs to be loaded in order to perform the desired translations. The DDCC IG and the SHC IG can be loaded via the following curl commands against the Matchbox server:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'curl -X \'POST\' \\\n  \'http://localhost:8080/matchbox/fhir/ImplementationGuide\' \\\n  -H \'accept: application/fhir+json\' \\\n  -H \'Content-Type: application/fhir+json\' \\\n  -d \'{ "resourceType": "ImplementationGuide", "version": "1.0.0", "name": "fhir.who.ddcc", "url": "http://worldhealthorganization.github.io/ddcc/package.tgz" }\'\n')),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'curl -X \'POST\' \\\n  \'http://localhost:8080/matchbox/fhir/ImplementationGuide\' \\\n  -H \'accept: application/fhir+json\' \\\n  -H \'Content-Type: application/fhir+json\' \\\n  -d \'{ "resourceType": "ImplementationGuide", "version": "0.6.2", "name": "hl7.fhir.uv.shc-vaccination", "packageId": "hl7.fhir.uv.shc-vaccination" }\'\n')),(0,r.kt)("h3",{id:"converting-the-vaccination-into-ddcc-fhir-resource"},"Converting the Vaccination Into DDCC FHIR resource"),(0,r.kt)("p",null,"This is a two step process. The first step is to convert the vaccination credential payload into the DDCC CoreDataSet logical model using the ",(0,r.kt)("a",{parentName:"p",href:"https://worldhealthorganization.github.io/ddcc/artifacts.html#terminology-structure-maps"},"appropriate StructureMap from the DDCC IG"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"curl -X 'POST' \\\n'http://localhost:8080/matchbox/fhir/StructureMap/$transform?source=http://worldhealthorganization.github.io/ddcc/StructureMap/CertSHCtoCoreDataSet' \\\n-H 'accept: application/fhir+json' \\\n-H 'Content-Type: application/fhir+json' \\\n-d @example-00-b-jws-payload-expanded.json \\\n-o example-00-a-DDCCCoreDataSet.json\n")),(0,r.kt)("p",null,"This should result in a new file containing the vaccine information in the intermediary CoreDataSet format. The data in the intermediary format can then be converted to a DDCC FHIR resource instance:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"curl -X 'POST' \\\n'http://localhost:8080/matchbox/fhir/StructureMap/$transform?source=http://worldhealthorganization.github.io/ddcc/StructureMap/CoreDataSetVSToAddBundle' \\\n-H 'accept: application/fhir+json' \\\n-H 'Content-Type: application/fhir+json' \\\n-d @example-00-a-DDCCCoreDataSet.json \\\n-o example-00-a-DDCC.json\n")),(0,r.kt)("p",null,(0,r.kt)("em",{parentName:"p"},"NOTE: These conversion steps are still being debugged, particularly the final one, and the CQL has not been tested against the final version")),(0,r.kt)("p",null,"The record is now ready to be evaluated against the business rules."),(0,r.kt)("h2",{id:"running-cql-against-converted-vaccination-credentials"},"Running CQL Against Converted Vaccination Credentials"),(0,r.kt)("p",null,"Running CQL business rules against a record requires translating the CQL to the Expression Logical Model (ELM) representation and running the ELM in a CQL execution engine. For this document we'll start with one of the ",(0,r.kt)("a",{parentName:"p",href:"https://worldhealthorganization.github.io/ddcc/artifacts.html#knowledge-artifacts-libraries"},"examples from the DDCC IG"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-cql"},'// Declare the name and version of the Library of functions\nlibrary DDCCPass version \'1.0.0\'\n\n// The version of FHIR we are using\nusing FHIR version \'4.0.1\'\n\n// Execute all business rules relative to a specific Patient content\ncontext Patient\n\n// Define boolean valued business rule to check if there is an immunization that was completed\ndefine "Completed Immunization": exists ("Completed Immunizations")\n\n// Define a list of completed immunizations for which the dose number is the same as the series dose\n// Immunization resources are queried from those that reference the Patient we are executing against\ndefine "Completed Immunizations":\n  [Immunization] I\n    where ( I.protocolApplied.doseNumber.value = I.protocolApplied.seriesDoses.value )\n')),(0,r.kt)("p",null,"You can place this example in a file called ",(0,r.kt)("inlineCode",{parentName:"p"},"DDCCPass.cql")," and modify it as desired before proceeding."),(0,r.kt)("h3",{id:"translating-cql-to-elm"},"Translating CQL to ELM"),(0,r.kt)("p",null,"CQL can be translated to ELM using the CQL Translation Service docker image. The following command starts the docker image on a local machine listening on port 8081:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"docker run -d -p 8081:8080 --restart unless-stopped cqframework/cql-translation-service:latest\n")),(0,r.kt)("p",null,"Once the translation service is running the CQL can be translated to ELM using the following curl command:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'curl -X "POST" \\\n--url "http://localhost:8081/cql/translator/" \\\n--header "Content-Type: application/cql" \\\n--header "Accept: application/elm+json" \\\n--data-binary @DDCCPass.cql \\\n--output DDCCPassELM.json\n')),(0,r.kt)("h3",{id:"running-elm-against-converted-vaccination-credentials"},"Running ELM Against Converted Vaccination Credentials"),(0,r.kt)("p",null,"The ELM translation of the CQL can be run against the vaccination record using the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/cqframework/cql-execution"},"JavaScript CQL Execution Framework library")," along with the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/cqframework/cql-exec-fhir"},"JavaScript CQL Execution FHIR Data Source"),". This document describes how to set this up in a simple Node.js project. Node.js will first need to be installed if it is not already available. A new Node.js project with the needed CQL libraries can be set up using npm:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"mkdir CQLDemo\ncd CQLDemo\nnpm init --yes\nnpm install cql-execution cql-exec-fhir\n")),(0,r.kt)("p",null,"Once the project is set up the ELM from the CQL business rules can be evaluated against the vaccination credential that was converted to the DDCC resource instance. The following example JavaScript code can serve as a starting point:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"// This example loads an ELM file and vaccination records and evaluates\n// the ELM against each record\n\nconst { argv, exit } = require('process');\nconst fs = require('fs');\nconst cql = require('cql-execution');\nconst cqlfhir = require('cql-exec-fhir');\n\nif (argv.length < 4) {\n  console.log(`Usage: ${argv[0]} ${argv[1]} <ELM-file> <vaccination-record>...`);\n  exit();\n}\n\nconst elmFile = argv[2];\nconst recordFiles = argv.slice(3);\n\n// Load the ELM and set up the execution environment\nconst elm = JSON.parse(fs.readFileSync(elmFile), 'utf8');\nconst library = new cql.Library(elm);\nconst executor = new cql.Executor(library);\n\n// Load all the vaccination records\nconst patientSource = cqlfhir.PatientSource.FHIRv401();\nconst records = recordFiles.map(filename => JSON.parse(fs.readFileSync(filename, 'utf8')));\npatientSource.loadBundles(records);\n\n// Execute the business rules against the records and show the results\nconst results = executor.exec(patientSource);\nconsole.log(results);\n")),(0,r.kt)("p",null,"This code can be run to execute the business rules against the resource using the following command:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"node main.js DDCCPassELM.json example-00-a-DDCC.json\n")),(0,r.kt)("p",null,"Running the script should produce results that look similar to this:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"Results {\n  patientResults: {\n    \"ac1efa5f-9a92-48be-95a1-0550f18a349c\": {\n      Patient: [FHIRObject],\n      'Completed Immunizations': [Array],\n      'Completed Immunization': true\n    }\n  },\n  unfilteredResults: {},\n  localIdPatientResultsMap: { 'ac1efa5f-9a92-48be-95a1-0550f18a349c': { DDCCPass: {} } },\n  patientEvaluatedRecords: {\n    'ac1efa5f-9a92-48be-95a1-0550f18a349c': [ [FHIRObject], [FHIRObject] ]\n  }\n}\n")))}p.isMDXComponent=!0}}]);